<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BeeSafe Project: Overview</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../beeSmall.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BeeSafe Project
   &#160;<span id="projectnumber">v1.0</span>
   </div>
   <div id="projectbrief">Low-cost tracking device.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('db/d94/md_doc_wiki_u_blox-and-_cell_locate.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The following information summarises the <a href="../../#celllocate"><code>CellLocate</code></a> feature and the <a href="../../#u-blox-command-guide"><code>AT command guides from u-box</code></a>, allowing to use the u-blox SARA-G350 module to detect its location and send text messages and data through the mobile network. At the bottom of this page, a few <a href="../../#additional-importanthelpful-commands"><code>Additional Important/Helpful Commands</code></a> can be found</p>
<p>The information was obtained from the following sources:</p><ul>
<li><a href="https://www.u-blox.com/sites/default/files/products/documents/CellLocate_ProductSummary_%28UBX-15011829%29.pdf"><code>CellLocate Product Summary</code></a></li>
<li><a href="https://www.u-blox.com/sites/default/files/GNSS-Implementation_AppNote_%28UBX-13001849%29.pdf"><code>Positioning Application Note</code></a></li>
<li><a href="https://www.u-blox.com/sites/default/files/AT-CommandsExamples_AppNote_%28UBX-13001820%29.pdf"><code>AT Commands Examples Application Note</code></a></li>
<li><a href="https://www.u-blox.com/en/docs/UBX-13002752"><code>AT Command Guide</code></a></li>
</ul>
<h1>CellLocate</h1>
<p>Some short description about the CellLocate feature:</p>
<blockquote class="doxtable">
<p>This technology enables stand-alone location estimation based on surrounding mobile network information in conjunction with GNSS positioning data to improve positioning. For any given location with cellular network coverage (2G, 3G or 4G), a specific combination of network cells will be visible. The proprietary CellLocate feature allows u-blox cellular modules to report to the CellLocate server those cells which are visible at any specific location. This enables the server to estimate a coarse position based on previous observations from other modules reporting the same cell visibility pattern, and this position is reported back to the module. The estimated position is then output by the module to the host processor via its serial port. </p>
</blockquote>
<blockquote class="doxtable">
<p>Network cells are widely available in urban and rural environments enabling the CellLocate service to provide a position estimate virtually everywhere and under any conditions. The service is offered free of charge on a best effort basis and the performance depends on the density of network cells and database population. A self-learning mechanism is implemented allowing continuous database improvement and update to increase performance over time and prevent database ageing. </p>
</blockquote>
<div class="image">
<img src="https://github.com/itsBelinda/ENG5220-2020-Team13/blob/master/doc/media/cellLocate.png" alt="CellLocate explained." width="100%"/>
</div>
 <p>In case of privacy concerns, u-blox says they are unable to track SIM cards or devices: </p><blockquote class="doxtable">
<p>u-blox is extremely mindful of user privacy. When a position is sent to the CellLocate® server, u-blox is unable to track the SIM used or identify the specific device. </p>
</blockquote>
<p>However, each developer needs to be registered with u-blox by requesting an authentication token from their website. This can be done through this form: www.u-blox.com/services-form.html</p>
<blockquote class="doxtable">
<p>... authentication token as a means of authorizing access to the u-blox server and for gathering anonymous statistics. </p>
</blockquote>
<h1>u-blox Command Guide</h1>
<p>This quick guide will explain what steps need to be taken to be able to connect the u-blox module to the network, connect it to the CellLocate servers to be able to request the location and how to send a simple text message. This is to be used to jump-start software development.</p>
<p>u-blox suggests best practices for the software handling the communication to their modules on page 11 of the <a href="https://www.u-blox.com/sites/default/files/AT-CommandsExamples_AppNote_%28UBX-13001820%29.pdf"><code>AT Commands Examples App Note</code></a>.</p>
<p>Since February 2020, there is also a <a href="https://github.com/u-blox/cellular"><code>GitHub</code></a> page by u-blox, where they are currently developing a cellular API in C for embedded platforms.</p>
<p>Frequently used abbreviations in the u-blox documentation:</p><ul>
<li>DCE (Data Communications Equipment) or MT (Mobile Terminal) is the u-blox cellular module</li>
<li>DTE (Data Terminal Equipment) is the Raspberry PI</li>
<li>NVM (Non-volatile Memory)</li>
<li>IMEI (International Mobile Equipment Identity)</li>
</ul>
<h2>General CMD structure</h2>
<p>The image below shows the general command structure.</p>
<div class="image">
<img src="https://github.com/itsBelinda/ENG5220-2020-Team13/blob/master/doc/media/ATcmd_flow.png" alt="AT command structure" width="75%"/>
</div>
 <p>Specifically, a typical exchange looks like this:</p>
<table class="doxtable">
<tr>
<th>PI sends </th><th>SARA responds  </th></tr>
<tr>
<td>AT+&lt;cmd&gt; </td><td>&lt;echo&gt; </td></tr>
<tr>
<td></td><td>&lt;response&gt; (optional - can be empty) </td></tr>
<tr>
<td></td><td>&lt;result code&gt; </td></tr>
</table>
<p>Example: </p><table class="doxtable">
<tr>
<th>PI sends </th><th>SARA responds  </th></tr>
<tr>
<td>AT+UPSND=0.8</td><td>AT+UPSND=0.8 </td></tr>
<tr>
<td></td><td>+UPSND: 0,8,0 </td></tr>
<tr>
<td></td><td>OK </td></tr>
</table>
<h3>Result code can be:</h3>
<ul>
<li>OK</li>
<li>ERROR</li>
<li>ABORTED Error codes can be more informative if set to verbose with the following command: AT+CMEE=2</li>
</ul>
<h3>Unsolicited Result Code (URC)</h3>
<p>The commands can trigger an action that will eventually get a result. From the commands application note:</p>
<blockquote class="doxtable">
<p>An unsolicited result code (URC) is a string message (provided by the DCE) that is not a response to a previous AT command. It can be output, when enabled, at any time to inform the DTE of a specific event or status change. The URC can have the same name as the command that enables it (e.g. +CREG) or can be enabled by another command (e.g. unsolicited result code: +CMTI, command that enables it: +CNMI). </p>
</blockquote>
<p>This is used to get the location. The command will trigger a couple of server requests and eventually result in an answer that can be checked.</p>
<h3>Summary: Types of Commands</h3>
<p>Generally speaking, there are three types of commands/interactions:</p><ul>
<li>A command sent by the PI that is only acknowledged by the SARA module: only has an echo and the status.</li>
<li>A command sent by the PI that immediately gets a response (before the status). <br />
 If this command is not valid, or not understood, the SARA module will respond with an ERROR immediately, and no response will be sent. <br />
 A response can be more than just one line, depending on the command and the content (e.g. reading all text messages on the module will trigger a bunch of <code>+CMGL: ...</code> responses, each at least two lines long.)</li>
<li>A command sent by the PI that triggers sending of (one or more) URCs (e.g. the get location command). This command is echoed and acknowledged by the SARA module. After the command has been executed, the result is put out as a URC.</li>
</ul>
<h3>Reading/Setting Parameters</h3>
<p>Many commands have parameters (often multiple) that they can set. This is the general structure:</p><ul>
<li>reading a parameter: <code>AT+\&lt;cmd&gt;?\r</code></li>
<li>setting a parameter: <code>AT+\&lt;cmd&gt;=\&lt;x&gt;\r</code></li>
<li>requesting possible parameters: <code>AT+\&lt;cmd&gt;=?\r</code></li>
</ul>
<h2>Setting up the u-blox module</h2>
<p>Before the module can be used, it needs to be set up. Some parts can be configured and stored in NVM</p>
<p>Make sure the connected SIM card has already been activated and has a data plan. The above mentioned structure is now omitted and the following structure is now used: <code>\&lt;cmd&gt;</code> &ndash;&gt; <code>\&lt;response&gt;</code></p>
<h3>Entering the PIN:</h3>
<p>If the PIN is activated (recommended), it has to be entered after startup.</p>
<p>&ndash;&gt; Enter the PIN: <code>AT+CPIN="1234"\r</code><br />
 The command <code>AT+CPIN=?\r</code> does not return the PIN, but the status. This can be either <code>SIM PIN</code> or <code>READY</code>.</p>
<h3>Automatic network registration:</h3>
<p>This should happen automatically, if not it can be forced with:</p>
<p>Forces an attempt to select and register with the network operator: <code>AT+COPS=0</code></p>
<h4>Check GSM</h4>
<p>To check if everything is ok: <code>AT+COPS?</code> &ndash;&gt; <code>+COPS: 0,0,"O2 - UK"</code> If the first parameter is 0, the module is successfully registered with the GSM network.</p>
<h4>Check GPRS</h4>
<p><code>AT+CGATT?\r</code> &ndash;&gt; <code>+CGATT: 1\r</code> GPRS attach status (1: attached)</p>
<h4>Check Packet-Switched Data</h4>
<p>For this to work, some additional (one time only) setup is necessary. Afterwards, Packet-Switched (PS) network registration status can be checked: <code>AT+UCGOPS?\r</code> &ndash;&gt; <code>+UCGOPS: 0,0,"O2 - UK"\r</code><br />
 This does mean that an internet connection is available, but the <b>internet connection needs to be activated after every start-up</b>.</p>
<h3>PDP context activation:</h3>
<p>Check the status of the PDP connection profile (second digit: 8) associated to GPRS connection profile identifier "0" (first digit): <br />
 <code>AT+UPSND=0,8\r</code> &ndash;&gt; <code>+UPSND: 0,8,0\r</code><br />
 The last digit indicates the connection status (0: not connected, 1: connected).</p>
<h4>Initial setup</h4>
<p>The initial setup needs to be done once for a new device or to register for a new SIM card.<br />
 It is possible, that some of these commands are automatically set by the network provider, or that there are some commands missing because they were set automatically, by our network provider. This is to be treated as a guide and not as step-by-step instructions.<br />
</p><ol type="1">
<li>Set up APN for GPRS connection profile "0" (first digit). All following commands use the default profile "0". Up to 7 profiles (0-6) can be configured at the same time.<br />
 <code>AT+UPSD=0,1,"giffgaff.com"\r</code><br />
</li>
</ol>
<ol type="1">
<li>Dynamic IP address assignment <br />
 <code>AT+UPSD=0,7,"0.0.0.0"\r</code><br />
</li>
</ol>
<ol type="1">
<li>Save the configuration in NVM: <br />
 <code>AT+UPSDA=0,1\r</code> <br />
</li>
</ol>
<h4>Activate PDP</h4>
<p>Every time after start-up, the internet connection has to be separately activated. While all other connections should happen automatically, this needs to be done explicitly.</p><ol type="1">
<li>Activate GPRS connection (recommended to do this in +CGATT:1)<br />
 <code>AT+UPSDA=0,3\r</code> <br />
 This command could take a while to perform (&gt;1s in tests). The status OK is returned afterwards. In case of an error, there is not result returned (ERROR directly after the echo). <br />
</li>
</ol>
<ol type="1">
<li>Check the connection status <br />
 <code>AT+UPSND=0,8\r</code> &ndash;&gt; <code>+UPSND: 0,8,1\r</code> <br />
 This command should be regularly performed, if internet connection is necessary.</li>
</ol>
<ol type="1">
<li>Check if a IP address was assigned <br />
 <code>AT+UPSND=0,0\r</code> &ndash;&gt; <code>+UPSND: 0,0,"86.111.173.102"\r</code></li>
</ol>
<h2>Sending a text message without storing it:</h2>
<ol type="1">
<li>Setting the message format to text mode (PDU mode: 0) <br />
 <code>AT+CMGF=1\r</code></li>
</ol>
<ol type="1">
<li>Specify the number to send the message to. <br />
 <code>AT+CMGS="nbr"\r</code> <br />
 The DCE will send the echo followed by "&gt;" (on a new line)</li>
</ol>
<ol type="1">
<li>Send the message as a string. <br />
 <code>There can be line feeds, or whatever one likes :). However, with every \r, the SARA module will send the echo</code></li>
</ol>
<ol type="1">
<li>Send the message immediately<br />
 <code>&lt;ctrl-z&gt;</code> <br />
 Alternatively <code>&lt;ESC&gt;</code> discards the message. <br />
 Only now will the SARA module send the status (OK, ERROR).</li>
</ol>
<h2>Getting the CellLocate Location:</h2>
<p>First, the CellLocate server needs to be configured, this should be done separately from the main program. The setup needs a token, this should not be hardcoded into the software. (For more info see <a href="../../#celllocate">CellLocate</a>.)</p>
<p>This command checks the possible settings:<br />
 <code>AT+UGSRV=?\r</code> <br />
 <code>+UGSRV: "srv1","srv2","token",(1,2,3,5,7,10,14),(1-5),(1-3),(1,64,65),(0-2),(0-15)\r</code> <br />
</p><ul>
<li>The first two strings (note: they sent including the quotation marks!) specify the primary and secondary servers.</li>
<li>The third one is the authentification token.</li>
<li>The next value is the number of days the offline data should be valid for. Allowed values are shown above, the default value is 14.</li>
<li>The next value is the number of weeks the offline data should be valid for. The range is from 1-4, the default value is 4.</li>
<li>The next value is the resolution of the offline data in days. 1,2 and 3 are allowed values.</li>
<li>The next value is the GNSS type: <br />
<ul>
<li>1: GPS <br />
</li>
<li>64: GLONASS <br />
Default is 65 (both)</li>
</ul>
</li>
<li>The next value is the mode of the AssistNow Online data management.<br />
<ul>
<li>0: AssistNow Online data are downloaded at GNSS receiver power up<br />
</li>
<li>1: AssistNow Online data automatically kept alive<br />
</li>
<li>2: manual AssistNow Online data download<br />
</li>
</ul>
</li>
<li>The next value is the bitmask for the desired data types for the online aiding. <br />
<ul>
<li>0: time<br />
</li>
<li>1: position<br />
</li>
<li>2: ephemeris<br />
</li>
<li>4: almanac<br />
</li>
<li>8: auxiliary<br />
</li>
<li>16: ephemeris of satellites which are likely to be visible from the position estimated by the current registered network. This flag has no effect if the ephemeris flag is set to 0.<br />
 The default value is 15.<br />
 For a detailed description about all the parameters, see the <a href="https://www.u-blox.com/en/docs/UBX-13002752">AT Command Manual</a></li>
</ul>
</li>
</ul>
<h3>Configuring the CellLocate server:</h3>
<p>The initial setup needs to be done once for a new device or to register for a new SIM card with the above mentioned command.<br />
 Example (replace with valid token):<br />
 <code>AT+UGSRV="cell-live1.services.u-blox.com","cell-live2.services.u-blox.com","xxxxxxxxxxxxxxxxxxxxxx",14,4,1,65,0,15\r</code></p>
<h3>Get the Location from the CellLocate server:</h3>
<h4>Possible configuration</h4>
<p>To configure the CellLocate sensor, it is possible to configure what information the device reports to the server. There are two options:<br />
 (from the <a href="https://www.u-blox.com/sites/default/files/GNSS-Implementation_AppNote_%28UBX-13001849%29.pdf">Position Application Note</a>)</p><ul>
<li>“normal scan”: the cellular module only reports the parameters of the neighbouring visible cells designated by the network operator, which are normally collected by the module during its “network” activity. This configuration is suitable for a quick, rough update of location</li>
<li>“deep scan”: the cellular module scans and reports all visible cells. This gives not only the parameters of the visible cells of the serving network operator but also the cells of all other available network operators, thus improving location accuracy. Although this takes a bit longer time (approx 30 s to 2 minutes is needed to perform a deep scan), and requires more communication traffic, as more data is sent to the server (9 bytes for each cell), the coverage, reliability and accuracy are all substantially better if hybrid positioning is preconfigured to operate in the “deep scan” mode of operation</li>
</ul>
<p>This setting can b made with the following command: <br />
 <code>AT+ULOCCELL=&lt;scan_mode&gt;\r</code> <br />
</p><ul>
<li>0: normal scan<br />
</li>
<li>1: deep scan<br />
</li>
</ul>
<h4>Request Location</h4>
<p>The request location command specifies what type of location is requested, what response should be sent, timeouts and more: <br />
</p>
<p><code>AT+ULOC=&lt;mode&gt;,&lt;sensor&gt;,&lt;response_type&gt;,&lt;timeout&gt;,&lt;accuracy&gt;[,&lt;num_hypothesis&gt;]\r</code><br />
</p><ul>
<li>&lt;mode&gt;: always needs to be 2, the other values are reserved<br />
</li>
<li>&lt;sensor&gt;: What type of sensor to use (bitmask): <br />
<ul>
<li>0: use last fix in internal database<br />
</li>
<li>1: GNSS receiver (not included in our setup)<br />
</li>
<li>2: CellLocate<br />
</li>
</ul>
</li>
<li>&lt;response_type&gt; <br />
<ul>
<li>0: use last fix in internal database<br />
</li>
<li>1: GNSS receiver (not included in our setup)<br />
</li>
<li>2: CellLocate<br />
</li>
</ul>
</li>
<li>&lt;timeout&gt;: in seconds from 1 to 999</li>
<li>&lt;accuracy&gt;: in meters from 1 to 999999</li>
<li>&lt;num_hypothesis&gt;: (optional) maximal desired responses from CellLocate (max. 16).</li>
</ul>
<p>Example: <br />
 <code>AT+ULOC=2,2,0,60,500</code><br />
 This command will be echoed and answered quickly by the SARA module. The answer is only the status. Requesting the location can take a long time (see timeouts above), so the result is sent as a URC as soon as it is ready.</p>
<p>The response will have the following structure (for the response type "0"):<br />
 <code>+UULOC: &lt;date&gt;,&lt;time&gt;,&lt;lat&gt;,&lt;long&gt;,&lt;alt&gt;,&lt;uncertainty&gt;\r</code><br />
 <code>&lt;uncertainty&gt;</code> is the estimated 50% confidence level error in meters. <br />
</p>
<p>A possible response for response type "0":<br />
 <code>+UULOC:</code>02/04/2020,21:06:15.000,55.8367527,-42209088,0,248` <br />
 (The alert reader will be able to check where the PI was located during development.)</p>
<p>The image below shows the serial output of the test program that sets up the internet connection and reads the location from the device once: </p>
<div class="image">
<img src="https://github.com/itsBelinda/ENG5220-2020-Team13/blob/master/doc/media/ULOC_test.png" alt="Debug output of ULOC testing." width="100%"/>
</div>
 <h2>Additional Important/Helpful Commands</h2>
<table class="doxtable">
<tr>
<th>Command </th><th>Example response (echo &amp; status omitted) </th><th>Description  </th></tr>
<tr>
<td><code>AT+CMEE=2\r</code> </td><td>none </td><td>Set the verbose error result codes. </td></tr>
<tr>
<td><code>ATI0\r</code> </td><td><code>SARA-G350-02X-01</code> </td><td>Get product type number. (0 is the default value and can be omitted, <code>ATI</code> gives the same result as <code>ATI0</code>. </td></tr>
<tr>
<td><code>ATI5\r</code> </td><td><code>355989070341461</code> </td><td>Get IMEI number. </td></tr>
<tr>
<td><code>AT+CMGL\r</code> </td><td><code>+CMGL: 1,"REC READ","11111",,"20/03/13,10:20:25+00"</code><br />
This is just an example of a text message, there could be more than one. </td><td>Read all stored text messages. </td></tr>
<tr>
<td><code>AT+UPSV=0\r</code> </td><td>none </td><td>Disable power saving. (When in power saving mode, the device will use the first character as an interrupt to wake up.) </td></tr>
<tr>
<td><code>AT+CFUN=15\r</code> </td><td>none </td><td>Save the stored configuration and reboot the module without needing to switch the module off and back on. </td></tr>
<tr>
<td><code>AT+CPWROFF\r</code> </td><td>none </td><td>Save the stored configuration and switch the off. </td></tr>
<tr>
<td><code>AT+UPSDA=0,4\r</code> </td><td>none </td><td>Deactivate the PDP context (internet). </td></tr>
<tr>
<td><code>AT+UPING="google.com"\r</code> </td><td>URC reporting on success or failure:<br />
 <code>+UUPINGER: &lt;errorcode&gt;</code> in case of failure <br />
 <code>+UUPING &lt;results&gt;</code> (4x) if successful </td><td>Ping a remote host. </td></tr>
</table>
<p>(to be updated if needed) </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
